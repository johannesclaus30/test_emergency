<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Simple P2P Chat (QR Scan)</title>
  <script src="https://unpkg.com/simple-peer@9.11.0/simplepeer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="p-6">
  <h1 class="text-2xl font-bold mb-4">Simple Peer-to-Peer Chat (QR Edition)</h1>

  <!-- Start as initiator -->
  <div class="mb-4">
    <button id="startInitiator" class="bg-blue-500 text-white px-4 py-2 rounded">Start as Initiator</button>
  </div>

  <!-- Signal exchange -->
  <div class="mb-4">
    <h2 class="font-semibold">Your Signal Data (QR Code)</h2>
    <textarea id="mySignal" class="w-full p-2 border rounded h-24 mb-2" readonly></textarea>
    <div id="qrcode" class="p-2 border inline-block"></div>
  </div>

  <div class="mb-4">
    <h2 class="font-semibold">Paste Remote Signal Data:</h2>
    <textarea id="remoteSignal" class="w-full p-2 border rounded h-32"></textarea>
    <div class="flex gap-2 mt-2">
      <button id="connectBtn" class="bg-green-500 text-white px-4 py-2 rounded">Connect</button>
      <button id="scanBtn" class="bg-yellow-500 text-white px-4 py-2 rounded">Scan QR</button>
    </div>
  </div>

  <!-- QR Scanner -->
  <div id="qrScanner" class="hidden mb-4">
    <h2 class="font-semibold">Scan Initiator's QR Code</h2>
    <div id="reader" class="w-64 h-64 border"></div>
    <button id="stopScan" class="mt-2 bg-red-500 text-white px-4 py-2 rounded">Stop Scanning</button>
  </div>

  <!-- Chat UI -->
  <div class="mb-4">
    <h2 class="font-semibold">Chat</h2>
    <div id="messages" class="border p-2 h-40 overflow-y-auto mb-2 bg-gray-50"></div>
    <input id="messageInput" class="border p-2 w-3/4" placeholder="Type a message..."/>
    <button id="sendBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Send</button>
  </div>

  <script>
    let peer;
    let qrScanner;

    function createPeer(initiator) {
      peer = new SimplePeer({
        initiator,
        trickle: false,
        config: {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            {
              urls: 'turn:openrelay.metered.ca:80',
              username: 'openrelayproject',
              credential: 'openrelayproject'
            },
            {
              urls: 'turn:openrelay.metered.ca:443',
              username: 'openrelayproject',
              credential: 'openrelayproject'
            },
            {
              urls: 'turn:openrelay.metered.ca:443?transport=tcp',
              username: 'openrelayproject',
              credential: 'openrelayproject'
            }
          ]
        }
      });

      peer.on('signal', data => {
        const json = JSON.stringify(data);
        document.getElementById('mySignal').value = json;

        // Generate QR code
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
          text: json,
          width: 200,
          height: 200
        });
      });

      peer.on('connect', () => {
        addMessage("✅ Connected!", "system");
      });

      peer.on('data', data => {
        addMessage(data.toString(), "peer");
      });

      peer.on('error', err => {
        addMessage("❌ Error: " + err.message, "system");
      });

      peer.on('close', () => {
        addMessage("⚠️ Connection closed", "system");
      });
    }

    function addMessage(text, sender) {
      const msgBox = document.getElementById('messages');
      const div = document.createElement('div');
      div.textContent = sender + ": " + text;
      msgBox.appendChild(div);
      msgBox.scrollTop = msgBox.scrollHeight;
    }

    document.getElementById('startInitiator').onclick = () => {
      createPeer(true);
    };

    document.getElementById('connectBtn').onclick = () => {
      if (!peer) createPeer(false);
      const remoteSignal = document.getElementById('remoteSignal').value;
      try {
        peer.signal(JSON.parse(remoteSignal));
      } catch (e) {
        alert("⚠️ Invalid signal data");
      }
    };

    document.getElementById('sendBtn').onclick = () => {
      const input = document.getElementById('messageInput');
      const msg = input.value.trim();
      if (msg && peer && peer.connected) {
        peer.send(msg);
        addMessage(msg, "you");
        input.value = "";
      } else {
        alert("Not connected yet!");
      }
    };

    // QR scan button
    document.getElementById('scanBtn').onclick = () => {
      document.getElementById('qrScanner').classList.remove('hidden');
      qrScanner = new Html5Qrcode("reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 200 },
        (decodedText) => {
          document.getElementById('remoteSignal').value = decodedText;
          qrScanner.stop();
          document.getElementById('qrScanner').classList.add('hidden');
        },
        (error) => {
          // ignore scanning errors
        }
      );
    };

    // Stop scanning manually
    document.getElementById('stopScan').onclick = () => {
      if (qrScanner) {
        qrScanner.stop();
        document.getElementById('qrScanner').classList.add('hidden');
      }
    };
  </script>
</body>
</html>
